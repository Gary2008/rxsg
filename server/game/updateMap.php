<?php
require_once("./utils.php");

function createBuildings($cid) {
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ('$cid',120,6,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,100,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,110,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,140,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,150,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,101,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,111,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,141,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,151,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,102,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,112,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,122,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,132,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,142,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,152,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,103,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,113,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,123,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,133,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,143,5,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,153,7,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,104,8,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,114,9,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,124,10,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,134,11,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,144,12,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,154,13,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,105,14,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,115,15,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,125,16,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,135,17,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,145,18,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,155,19,10 )");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,199,20,10 )");
	
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,10,2,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,60,2,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,70,2,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,1,2,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,11,2,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,21,3,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,31,3,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,41,3,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,51,3,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,61,3,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,71,4,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,81,4,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,2,4,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,12,4,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,22,4,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,32,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,42,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,52,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,62,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,72,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,82,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,13,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,23,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,33,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,43,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,53,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,63,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,73,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,24,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,34,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,44,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,54,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,64,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,35,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,45,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,55,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,65,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,46,1,10)");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ($cid,56,1,10)");
}

function createTechnic($cid) {
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'1','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'2','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'3','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'4','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'5','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'6','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'7','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'8','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'9','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'10','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'11','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'12','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'13','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'14','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'15','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'16','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'17','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'18','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'19','10')");
	sql_query("replace into sys_city_technic (`cid`,`tid`,`level`) values ($cid,'20','10')");
}

function buildCity($cid,$cityname,$province) {
	sql_query("replace into sys_city (`cid`,`uid`,`name`,`type`,`state`,`province`) values ('$cid','0','$cityname','0','0','$province')"); 
	sql_query("delete from sys_building where `cid`='$cid'");
	sql_query("replace into sys_building (`cid`,`xy`,`bid`,`level`) values ('$cid','120','6','1')");
	sql_query("replace into sys_city_res_add (cid,food_rate,wood_rate,rock_rate,iron_rate,chief_add) values ('$cid',80,80,80,80,0)");
	sql_query("replace into mem_city_resource (`cid`,`people`,`food`,`wood`,`rock`,`iron`,`gold`,`food_max`,`wood_max`,`rock_max`,`iron_max`,`gold_max`,`food_add`,`wood_add`,`rock_add`,`iron_add`,`lastupdate`) values ('$cid','50','5000','5000','5000','5000','5000','10000','10000','10000','10000','1000000',100,100,100,100,unix_timestamp())");
	sql_query("replace into mem_city_schedule (`cid`,`create_time`,`next_good_event`,`next_bad_event`) values ('$cid',unix_timestamp(),unix_timestamp()-(unix_timestamp()+8*3600)%86400 + 86400 + 86400 * rand(),unix_timestamp()-(unix_timestamp()+8*3600)%86400 + 86400 + 86400 * rand())");
	
	createBuildings($cid);
	createTechnic($cid);
	sql_query("update sys_city_res_add set resource_changing=1 where cid=$cid ");
	updateCityResourceAdd($cid);
	updateCityPeopleMax($cid);
	updateCityGoldMax($cid);
}

function createOutCity($cids,$province) {
	foreach ($cids as $cid=>$type) {
		if ($type == 1) {
			$cityname = "山洞";
		} elseif ($type == 2) {
			$cityname = "部落";
		} elseif ($type == 3) {
			$cityname = "主寨";
		}
		sql_query("update sys_troops set task=1,state=1 where targetcid=$cid");
		$wid = cid2wid($cid);
		sql_query("update mem_world set state=0,type=0,level=10,maxlevel=10,ownercid=$cid where wid=$wid");
		//建造城池的建筑
		buildCity($cid,$cityname,$province);
		sql_query("update sys_city set type=$type where cid=$cid");
	}
	switch ($province) {
		case 14: sql_query("update sys_city set uid=262 where province=$province and uid<=896");break;
		case 15: sql_query("update sys_city set uid=832 where province=$province and uid<=896");break;
		case 16: sql_query("update sys_city set uid=398 where province=$province and uid<=896");break;
		case 17: sql_query("update sys_city set uid=261 where province=$province and uid<=896");break;
		case 18: sql_query("update sys_city set uid=608 where province=$province and uid<=896");break;
		default:break;
	}
}

//所有的野地名将都要迁出蛮夷之地。
$hids = sql_fetch_rows("select a.hid from sys_city_hero a,mem_world w where a.cid=(floor(w.wid / 10000) * 10 + floor(((w.wid % 100) / 10)))*1000 + floor((w.wid % 10000) / 100) * 10 + floor(w.wid % 10) and w.province>13 and a.npcid>0 and a.uid<1000;");

foreach ($hids as $hid) {
	$wid = sql_fetch_one_cell("select wid from mem_world where level>7 and province<=13 and ownercid=0 and state=0 and type>0 order by rand() limit 1");
	$cid = wid2cid($wid);
	sql_query("update sys_city_hero set cid='$cid' where hid={$hid['hid']}");
}

//把特定城池坐标的野地修改为平地，玩家兵力召回。
//匈奴
$cids1 = array(
'35095'=>3,
'15075'=>2,
'15095'=>2,
'45125'=>2,
'15235'=>2,
'5285'=>2,
'25075'=>1,
'55085'=>1,
'45075'=>1,
'65095'=>1,
'75105'=>1,
'65115'=>1,
'25105'=>1,
'55095'=>1,
'55125'=>1,
'65135'=>1,
'15145'=>1,
'5145'=>1,
'15155'=>1,
'15185'=>1,
'15195'=>1,
'15225'=>1,
'25215'=>1,
'25225'=>1,
'35255'=>1,
'25175'=>1,
'15295'=>1,
'5295'=>1,
);
createOutCity($cids1,14);
//乌丸
$cids2 = array(
'15395'=>3,
'5365'=>2,
'5415'=>2,
'5335'=>1,
'15375'=>1,
'25365'=>1,
'15375'=>1,
'5425'=>1,
'5395'=>1,
);
createOutCity($cids2,15);
//羌
$cids3 = array(
'235025'=>3,
'295015'=>2,
'280015'=>2,
'215035'=>2,
'325005'=>1,
'295005'=>1,
'315025'=>1,
'255005'=>1,
'275015'=>1,
'205025'=>1,
'265005'=>1,
'265035'=>1,
'195005'=>1,
'325015'=>1,
'305035'=>1,
'235045'=>1,
);
createOutCity($cids3,16);
$cids4 = array(
'485035'=>3,
'465015'=>2,
'485065'=>2,
'495005'=>1,
'465025'=>1,
'475015'=>1,
'475065'=>1,
'465095'=>1,
'465075'=>1,
'475085'=>1,
);
createOutCity($cids4,17);
$cids5 = array(
'455475'=>3,
'475445'=>2,
'375495'=>2,
'445475'=>2,
'465425'=>1,
'435425'=>1,
'465455'=>1,
'395485'=>1,
'415465'=>1,
'405495'=>1,
'395495'=>1,
'435485'=>1,
'465475'=>1,
'465485'=>1,
'495465'=>1,
'485495'=>1,
'435445'=>1,
);
createOutCity($cids5,18);
